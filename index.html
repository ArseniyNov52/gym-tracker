<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gym Progress Tracker Pro</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RH1WWR3XTP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-RH1WWR3XTP');
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
/* ----------  –ë–ê–ó–û–í–´–ï / –°–ï–¢–ö–ê  ---------- */
* {margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
     background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#212529}
.container{max-width:800px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
.header h1{font-size:28px;margin-bottom:10px}
.timer{font-size:36px;font-weight:700;margin-top:10px;font-family:"Courier New",monospace}
.nav{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef;overflow-x:auto}
.nav-btn{flex:1;min-width:90px;padding:15px 10px;background:none;border:none;cursor:pointer;font-size:13px;font-weight:600;color:#6c757d;transition:all .3s;white-space:nowrap}
.nav-btn.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
.content{padding:30px;min-height:400px}
.section{display:none}.section.active{display:block}
.btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:14px 24px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;transition:transform .2s;width:100%}
.btn:hover{transform:translateY(-2px)}
.btn-secondary{background:#6c757d}.btn-danger{background:#dc3545}.btn-success{background:#28a745}
.btn-small{padding:10px 18px;font-size:14px;width:auto}
.btn-group{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.input-group{margin-bottom:20px}.input-group label{display:block;margin-bottom:8px;font-weight:600}
.input-group input,.input-group select,.input-group textarea{width:100%;padding:12px;border:2px solid #e9ecef;border-radius:8px;font-size:16px}
.spinner-input{display:flex;align-items:center;gap:10px}
.spinner-btn{width:55px;height:55px;font-size:28px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none;font-weight:700}
.spinner-btn:active{transform:scale(.95);background:#5568d3}
.spinner-value{flex:1;text-align:center;font-size:34px;font-weight:700;color:#667eea;padding:12px;background:#f8f9fa;border-radius:8px;min-width:100px}
input.spinner-value{border:none;outline:none;height:auto;-moz-appearance:textfield}
input.spinner-value::-webkit-outer-spin-button,input.spinner-value::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.mood-selector{display:flex;justify-content:space-around;gap:8px;margin-top:10px}
.mood-btn{flex:1;padding:15px;font-size:32px;background:#f8f9fa;border:3px solid #e9ecef;border-radius:12px;cursor:pointer;transition:all .3s}
.mood-btn.selected{border-color:#667eea;background:#e7e9fc;transform:scale(1.1)}
.mood-btn[data-mood="1"]{filter:grayscale(50%)}.mood-btn[data-mood="5"].selected{animation:pulse 1s infinite}
@keyframes pulse{0%,100%{transform:scale(1.1)}50%{transform:scale(1.15)}}
.exercise-list{list-style:none}.exercise-item{background:#f8f9fa;padding:15px;margin-bottom:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
.exercise-item strong{font-size:16px}.exercise-actions{display:flex;gap:10px}
.workout-exercise{background:#f8f9fa;padding:20px;margin-bottom:20px;border-radius:12px;border:2px solid #e9ecef}
.workout-exercise h3{color:#667eea;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;font-size:18px}
.sets-list{list-style:none;margin-top:15px}.set-item{background:#fff;padding:15px;margin-bottom:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;border:2px solid #e9ecef}
.set-info{flex:1}.set-time{font-size:12px;color:#6c757d;margin-top:4px}.set-mood{font-size:24px;margin-left:10px}
.history-item{background:#f8f9fa;padding:20px;margin-bottom:15px;border-radius:12px;cursor:pointer;transition:all .3s;border:2px solid transparent}
.history-item:hover{border-color:#667eea;transform:translateX(5px)}.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.history-date{font-weight:600;color:#667eea}.history-badge{background:#667eea;color:#fff;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.history-details{margin-top:15px;padding-top:15px;border-top:2px solid #dee2e6;display:none}.history-item.expanded .history-details{display:block}
.chart-container{margin-top:30px;background:#f8f9fa;padding:20px;border-radius:12px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:30px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:12px;text-align:center}
.stat-value{font-size:28px;font-weight:700;margin-bottom:5px}.stat-label{font-size:12px;opacity:.9}
.empty-state{text-align:center;padding:60px 20px;color:#6c757d}.empty-state h3{font-size:24px;margin-bottom:10px}
.template-card{background:#f8f9fa;padding:20px;margin-bottom:15px;border-radius:12px;border:2px solid #e9ecef}
.template-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.template-name{font-weight:700;font-size:18px}.template-exercises{color:#6c757d;font-size:14px;margin-top:10px}
.weight-input-group{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid #667eea}
.weight-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}.modal-content{background:#fff;padding:30px;border-radius:20px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{font-size:24px;font-weight:700;margin-bottom:20px;color:#212529}
.achievement-category-title{font-size:22px;color:#667eea;margin-top:30px;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #e9ecef}
.achievement-category-title:first-of-type{margin-top:0}.achievements-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
.achievement-card{background:#f8f9fa;border:2px solid #e9ecef;border-radius:12px;padding:20px;text-align:center;transition:all .3s ease;filter:grayscale(100%) opacity(.6)}
.achievement-card.unlocked{filter:none;border-color:#667eea;background:#f0f2ff}.achievement-card.unlocked .achievement-icon{transform:scale(1.2);animation:pop .5s ease-out}
@keyframes pop{0%{transform:scale(.5)}80%{transform:scale(1.3)}100%{transform:scale(1.2)}}
.achievement-icon{font-size:48px;margin-bottom:15px;transition:transform .3s ease}.achievement-title{font-weight:700;font-size:18px;margin-bottom:5px}.achievement-desc{font-size:14px;color:#6c757d}
.exercise-group-title{font-weight:700;color:#667eea;margin-top:15px;margin-bottom:10px;font-size:14px;text-transform:uppercase}
.exercise-checkbox-label{display:block;margin-bottom:10px;padding:10px;background:#f8f9fa;border-radius:8px;cursor:pointer;transition:background .2s}
.exercise-checkbox-label:hover{background:#e7e9fc}.exercise-checkbox-label input[type=checkbox]{margin-right:10px}
.search-box{margin-bottom:20px}@media(max-width:600px){body{padding:0}.container{border-radius:0}.content{padding:20px}.btn-group{flex-direction:column}.nav{justify-content:flex-start}.stats-grid{grid-template-columns:repeat(2,1fr)}}
</style>
<base target="_blank">
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üí™ Gym Tracker Pro</h1>
    <p>–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º</p>
    <div class="timer" id="timer" style="display:none;">00:00:00</div>
  </div>

  <div class="nav">
    <button class="nav-btn active" onclick="showSection('workout')">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
    <button class="nav-btn" onclick="showSection('templates')">–®–∞–±–ª–æ–Ω—ã</button>
    <button class="nav-btn" onclick="showSection('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
    <button class="nav-btn" onclick="showSection('progress')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    <button class="nav-btn" onclick="showSection('achievements')">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
    <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è</button>
  </div>

  <div class="content">
    <div id="workout" class="section active"><h2>–¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2><div id="workoutContent"></div></div>
    <div id="templates" class="section"><h2>–®–∞–±–ª–æ–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2><div class="btn-group"><button class="btn" onclick="showCreateTemplateModal()">+ –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</button></div><div id="templatesList"></div></div>
    <div id="history" class="section"><h2>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2><div id="historyList"></div></div>
    <div id="progress" class="section"><h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</h2><div class="stats-grid" id="statsGrid"></div><div class="input-group"><label>–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label><select id="exerciseSelect" onchange="updateCharts()"><option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ --</option></select></div><div class="chart-container"><canvas id="weightChart"></canvas></div><div class="chart-container"><canvas id="volumeChart"></canvas></div><div class="chart-container"><canvas id="bodyWeightChart"></canvas></div><div class="chart-container"><canvas id="moodChart"></canvas></div></div>
    <div id="achievements" class="section"><h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2><div id="achievementsListContainer"></div></div>
    <div id="settings" class="section"><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><h3 style="margin:30px 0 15px 0;">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h3><div class="input-group"><label>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label><div style="display:flex;gap:10px;"><input type="text" id="newExerciseName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"><button class="btn btn-small" onclick="addExercise()">–î–æ–±–∞–≤–∏—Ç—å</button></div></div><button class="btn btn-small btn-secondary" onclick="viewAllExercises()" style="margin-bottom:20px">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button><ul id="exercisesList" class="exercise-list"></ul><h3 style="margin:30px 0 15px 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3><div class="btn-group"><button class="btn btn-secondary" onclick="exportData()">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button></div><div class="btn-group"><button class="btn btn-danger" onclick="confirmReset()">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button></div></div>
  </div>
</div>

<!-- =====  –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê  ===== -->
<div id="templateModal" class="modal" onclick="if(event.target===this) closeModal('templateModal')">
  <div class="modal-content">
    <div class="modal-header" id="templateModalTitle">–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
    <div class="input-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</label><input type="text" id="templateName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì—Ä—É–¥—å –∏ —Ç—Ä–∏—Ü–µ–ø—Å"></div>
    <div class="search-box"><label>–ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</label><input type="text" id="exerciseSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è..." onkeyup="filterExercises()"></div>
    <div class="input-group"><label>–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</label><div id="templateExercisesList" style="max-height:400px;overflow-y:auto;"></div></div>
    <div class="btn-group"><button class="btn" onclick="saveTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="closeModal('templateModal')">–û—Ç–º–µ–Ω–∞</button></div>
  </div>
</div>

<div id="viewTemplateModal" class="modal" onclick="if(event.target===this) closeModal('viewTemplateModal')">
  <div class="modal-content">
    <div class="modal-header" id="viewTemplateName"></div>
    <div id="viewTemplateContent"></div>
    <div class="btn-group"><button class="btn" onclick="startFromCurrentTemplate()">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button><button class="btn btn-secondary" onclick="closeModal('viewTemplateModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<div id="setModal" class="modal" onclick="if(event.target===this) closeModal('setModal')">
  <div class="modal-content">
    <div class="modal-header">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</div>
    <div class="input-group"><label>–í–µ—Å (–∫–≥)</label><div class="spinner-input"><button class="spinner-btn" onclick="changeValue('setWeight',-2.5)">‚àí</button><input type="number" class="spinner-value" id="setWeight" value="50.0" step="2.5"><button class="spinner-btn" onclick="changeValue('setWeight',2.5)">+</button></div></div>
    <div class="input-group"><label>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</label><div class="spinner-input"><button class="spinner-btn" onclick="changeValue('setReps',-1)">‚àí</button><input type="number" class="spinner-value" id="setReps" value="10" step="1"><button class="spinner-btn" onclick="changeValue('setReps',1)">+</button></div></div>
    <div class="input-group"><label>–ö–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ?</label><div class="mood-selector" id="moodSelector"><button class="mood-btn" data-mood="1" onclick="selectMood(1)">üò´</button><button class="mood-btn selected" data-mood="3" onclick="selectMood(3)">üòê</button><button class="mood-btn" data-mood="5" onclick="selectMood(5)">üòÑ</button></div></div>
    <div class="btn-group"><button class="btn" onclick="confirmAddSet()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button><button class="btn btn-secondary" onclick="addSetSameAsPrevious()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π</button></div><button class="btn btn-secondary" onclick="closeModal('setModal')" style="margin-top:10px;width:100%">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<div id="bodyWeightModal" class="modal" onclick="if(event.target===this) closeModal('bodyWeightModal')">
  <div class="modal-content">
    <div class="modal-header" id="bodyWeightModalTitle">–í–µ—Å —Ç–µ–ª–∞</div>
    <div class="input-group"><label>–í–∞—à –≤–µ—Å (–∫–≥)</label><div class="spinner-input"><button class="spinner-btn" onclick="changeValue('bodyWeightValue',-0.5)">‚àí</button><div class="spinner-value" id="bodyWeightValue">70</div><button class="spinner-btn" onclick="changeValue('bodyWeightValue',0.5)">+</button></div></div>
    <div class="btn-group"><button class="btn" onclick="confirmBodyWeight()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="closeModal('bodyWeightModal')">–û—Ç–º–µ–Ω–∞</button></div>
  </div>
</div>

<div id="exercisesLibraryModal" class="modal" onclick="if(event.target===this) closeModal('exercisesLibraryModal')">
  <div class="modal-content">
    <div class="modal-header">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>
    <div id="exercisesLibraryContent" style="max-height:60vh;overflow-y:auto;"></div>
    <div class="btn-group" style="margin-top:20px;"><button class="btn btn-secondary" onclick="closeModal('exercisesLibraryModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<script>
/* =================  –î–ê–ù–ù–´–ï –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï  ================= */
const exerciseDatabase = {
  '–ì—Ä—É–¥—å': ['–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞','–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –Ω–∞–∫–ª–æ–Ω–Ω–æ–π —Å–∫–∞–º—å–µ','–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞','–†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞','–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞','–°–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ ¬´–ë–∞–±–æ—á–∫–∞¬ª','–ö—Ä–æ—Å—Å–æ–≤–µ—Ä—ã'],
  '–°–ø–∏–Ω–∞': ['–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è','–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞','–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ','–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞ –∫ –≥—Ä—É–¥–∏','–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è','–®—Ä–∞–≥–∏ —Å–æ —à—Ç–∞–Ω–≥–æ–π'],
  '–ù–æ–≥–∏': ['–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å–æ —à—Ç–∞–Ω–≥–æ–π','–ñ–∏–º –Ω–æ–≥–∞–º–∏','–í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏','–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ','–°–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ','–ü–æ–¥—ä–µ–º—ã –Ω–∞ –Ω–æ—Å–∫–∏'],
  '–ü–ª–µ—á–∏': ['–ê—Ä–º–µ–π—Å–∫–∏–π –∂–∏–º','–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è','–ú–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª–µ–π –≤ —Å—Ç–æ—Ä–æ–Ω—ã','–ú–∞—Ö–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ','–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –∫ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É'],
  '–ë–∏—Ü–µ–ø—Å': ['–ü–æ–¥—ä–µ–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –±–∏—Ü–µ–ø—Å','–ü–æ–¥—ä–µ–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ –±–∏—Ü–µ–ø—Å','–°–≥–∏–±–∞–Ω–∏—è ¬´–º–æ–ª–æ—Ç¬ª','–°–≥–∏–±–∞–Ω–∏—è –Ω–∞ —Å–∫–∞–º—å–µ –°–∫–æ—Ç—Ç–∞'],
  '–¢—Ä–∏—Ü–µ–ø—Å': ['–ñ–∏–º –ª–µ–∂–∞ —É–∑–∫–∏–º —Ö–≤–∞—Ç–æ–º','–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º','–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–ª–æ–∫–µ','–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö'],
  '–ü—Ä–µ—Å—Å': ['–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è','–ü–æ–¥—ä–µ–º –Ω–æ–≥ –≤ –≤–∏—Å–µ','–ú–æ–ª–∏—Ç–≤–∞ –Ω–∞ –±–ª–æ–∫–µ']
};
let exercises = [];
let workouts = JSON.parse(localStorage.getItem('workouts')) || [];
let templates = JSON.parse(localStorage.getItem('templates')) || [];
let currentWorkout = null, currentExerciseForSet = null, currentMood = 3, currentBodyWeightType = null;
let currentViewingTemplate = null, currentEditingTemplateId = null;
let timerInterval = null, timerStart = null;
let weightChart = null, volumeChart = null, bodyWeightChart = null, moodChart = null;
let unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];

/* =================  –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø  ================= */
function initializeExercises() {
  exercises = [];
  let id = 1;
  for (const [group, exList] of Object.entries(exerciseDatabase)) {
    exList.forEach(name => exercises.push({id: id++, name, group, system: true}));
  }
  const saved = JSON.parse(localStorage.getItem('exercises')) || [];
  const user = saved.filter(ex => !ex.system);
  user.forEach(ex => exercises.push({...ex, id: id++}));
}
initializeExercises();

/* =================  –¢–ê–ô–ú–ï–†  ================= */
function startTimer() {
  timerStart = Date.now();
  document.getElementById('timer').style.display = 'block';
  timerInterval = setInterval(updateTimer, 1000);
  updateTimer();
}
function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  document.getElementById('timer').style.display = 'none';
}
function updateTimer() {
  if (!timerStart) return;
  const e = Date.now() - timerStart, h = Math.floor(e / 3600000), m = Math.floor((e % 3600000) / 60000), s = Math.floor((e % 60000) / 1000);
  document.getElementById('timer').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* =================  –ù–ê–í–ò–ì–ê–¶–ò–Ø / –ú–û–î–ê–õ–ö–ò  ================= */
function showSection(sec) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(sec).classList.add('active'); event.target.classList.add('active');
  if (sec === 'workout') renderWorkout();
  if (sec === 'templates') renderTemplates();
  if (sec === 'history') renderHistory();
  if (sec === 'progress') renderProgress();
  if (sec === 'achievements') renderAchievements();
  if (sec === 'settings') renderExercises();
}
function showModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

/* =================  –°–ü–ò–ù–ù–ï–†–´  ================= */
function changeValue(elId, delta) {
  const el = document.getElementById(elId);
  let v = (el.value !== undefined ? parseFloat(el.value) : parseFloat(el.textContent)) || 0;
  v = Math.max(0, v + delta);
  if (el.value !== undefined) { el.value = (elId === 'setWeight' ? v.toFixed(1) : Math.round(v)); }
  else { el.textContent = (elId === 'bodyWeightValue' ? v.toFixed(1) : Math.round(v)); }
}
function selectMood(m) {
  currentMood = parseInt(m);
  document.querySelectorAll('#moodSelector .mood-btn').forEach(b => b.classList.toggle('selected', parseInt(b.dataset.mood) === currentMood));
}

/* =================  –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø (–ù–ê–î–Å–ñ–ù–û)  ================= */
function addExercise() {
  const name = document.getElementById('newExerciseName').value.trim();
  if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
  if (exercises.some(ex => ex.name.toLowerCase() === name.toLowerCase())) return alert('–¢–∞–∫–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
  exercises.push({id: Date.now(), name, group: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ', system: false});
  saveData(); document.getElementById('newExerciseName').value = '';
  renderExercises(); if (document.getElementById('templateModal').classList.contains('active')) renderTemplateExercisesList();
  alert(`–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ¬´${name}¬ª –¥–æ–±–∞–≤–ª–µ–Ω–æ!`);
}
function deleteExercise(id) {
  const ex = exercises.find(e => e.id === id);
  if (!ex || ex.system) return alert(ex && ex.system ? '–°–∏—Å—Ç–µ–º–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è' : '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
  const used = templates.some(t => t.exercises.some(e => e.exerciseId === id));
  if (used) return alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –≤ —à–∞–±–ª–æ–Ω–∞—Ö');
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å ¬´${ex.name}¬ª?`)) return;
  exercises = exercises.filter(e => e.id !== id);
  templates = templates.map(t => ({...t, exercises: t.exercises.filter(e => e.exerciseId !== id)}));
  saveData(); renderExercises(); if (document.getElementById('templateModal').classList.contains('active')) renderTemplateExercisesList();
  alert('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
}

/* =================  –®–ê–ë–õ–û–ù–´  ================= */
function showCreateTemplateModal() { currentEditingTemplateId = null; document.querySelector('#templateModal .modal-header').textContent = '–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏'; document.getElementById('templateName').value = ''; document.getElementById('exerciseSearch').value = ''; renderTemplateExercisesList(); showModal('templateModal'); }
function showEditTemplateModal(id) { currentEditingTemplateId = id; const t = templates.find(x => x.id === id); document.querySelector('#templateModal .modal-header').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω'; document.getElementById('templateName').value = t.name; document.getElementById('exerciseSearch').value = ''; renderTemplateExercisesList(); const sel = new Set(t.exercises.map(e => e.exerciseId)); document.querySelectorAll('#templateExercisesList input').forEach(cb => cb.checked = sel.has(parseInt(cb.value))); showModal('templateModal'); }
function renderTemplateExercisesList() {
  const cont = document.getElementById('templateExercisesList'), sel = currentEditingTemplateId ? new Set(templates.find(t => t.id === currentEditingTemplateId).exercises.map(e => e.exerciseId)) : new Set();
  let html = '', grp = '';
  [...exercises].sort((a, b) => (a.group || '–ü—Ä–æ—á–∏–µ').localeCompare(b.group || '–ü—Ä–æ—á–∏–µ') || a.name.localeCompare(b.name)).forEach(ex => {
    if (ex.group !== grp) { grp = ex.group || '–ü—Ä–æ—á–∏–µ'; html += `<div class="exercise-group-title">${grp}</div>`; }
    html += `<label class="exercise-checkbox-label"><input type="checkbox" value="${ex.id}" ${sel.has(ex.id) ? 'checked' : ''}> ${ex.name}${ex.system ? '' : ' <span style="color:#6c757d;font-size:12px;">(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ)</span>'}</label>`;
  });
  cont.innerHTML = html || '<p style="color:#6c757d;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>';
}
function filterExercises() {
  const s = document.getElementById('exerciseSearch').value.toLowerCase(); if (!s) return renderTemplateExercisesList();
  const cont = document.getElementById('templateExercisesList'), checked = new Set([...cont.querySelectorAll('input:checked')].map(i => parseInt(i.value)));
  let html = '', grp = '';
  [...exercises].filter(ex => ex.name.toLowerCase().includes(s)).sort((a, b) => (a.group || '–ü—Ä–æ—á–∏–µ').localeCompare(b.group || '–ü—Ä–æ—á–∏–µ')).forEach(ex => {
    if (ex.group !== grp) { grp = ex.group || '–ü—Ä–æ—á–∏–µ'; html += `<div class="exercise-group-title">${grp}</div>`; }
    html += `<label class="exercise-checkbox-label"><input type="checkbox" value="${ex.id}" ${checked.has(ex.id) ? 'checked' : ''}> ${ex.name}</label>`;
  });
  cont.innerHTML = html || '<p style="color:#6c757d;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
}
function saveTemplate() {
  const name = document.getElementById('templateName').value.trim();
  if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
  const checked = [...document.querySelectorAll('#templateExercisesList input:checked')].map(i => parseInt(i.value)).filter(id => exercises.some(e => e.id === id));
  if (!checked.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ');
  const data = {id: currentEditingTemplateId || Date.now(), name, exercises: checked.map(id => ({exerciseId: id, exerciseName: exercises.find(e => e.id === id).name}))};
  if (currentEditingTemplateId) { const i = templates.findIndex(t => t.id === currentEditingTemplateId); if (i !== -1) templates[i] = {...templates[i], ...data}; } else templates.push({...data, createdAt: new Date().toISOString()});
  saveData(); closeModal('templateModal'); renderTemplates(); alert(`–®–∞–±–ª–æ–Ω ¬´${name}¬ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω!`);
}
function deleteTemplate(id) { if (!confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')) return; templates = templates.filter(t => t.id !== id); saveData(); renderTemplates(); }
function viewTemplate(id) { const t = templates.find(x => x.id === id); currentViewingTemplate = t; document.getElementById('viewTemplateName').textContent = t.name; document.getElementById('viewTemplateContent').innerHTML = `<ul class="sets-list">${t.exercises.map((ex,i)=>`<li class="set-item"><strong>${i+1}.</strong> ${ex.exerciseName}</li>`).join('')}</ul>`; showModal('viewTemplateModal'); }
function startFromTemplate(id) { const t = templates.find(x => x.id === id); currentWorkout = {id: Date.now(), startDate: new Date().toISOString(), endDate: null, templateName: t.name, bodyWeightBefore: null, bodyWeightAfter: null, overallMood: null, exercises: t.exercises.map(ex => ({...ex, sets:[]}))}; startTimer(); showSection('workout'); renderWorkout(); }
function startFromCurrentTemplate() { if (!currentViewingTemplate) return; closeModal('viewTemplateModal'); startFromTemplate(currentViewingTemplate.id); }
function renderTemplates() {
  const list = document.getElementById('templatesList');
  if (!templates.length) { list.innerHTML = '<div class="empty-state"><h3>–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤</h3><p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —à–∞–±–ª–æ–Ω</p></div>'; return; }
  list.innerHTML = templates.map(t => `
    <div class="template-card">
      <div class="template-header"><span class="template-name">${t.name}</span><button class="btn btn-small btn-danger" onclick="event.stopPropagation();deleteTemplate(${t.id})">√ó</button></div>
      <div class="template-exercises">${t.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: ${t.exercises.map(e=>e.exerciseName).join(', ')}</div>
      <div class="btn-group" style="margin-top:15px;"><button class="btn btn-small" onclick="viewTemplate(${t.id})">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button><button class="btn btn-small btn-secondary" onclick="showEditTemplateModal(${t.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="btn btn-small btn-success" onclick="startFromTemplate(${t.id})">–ù–∞—á–∞—Ç—å</button></div>
    </div>`).join('');
}

/* =================  –¢–†–ï–ù–ò–†–û–í–ö–ò  ================= */
function startWorkout() {
  currentWorkout = {id: Date.now(), startDate: new Date().toISOString(), endDate: null, templateName: '–°–≤–æ–±–æ–¥–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', bodyWeightBefore: null, bodyWeightAfter: null, overallMood: null, exercises: exercises.map(ex => ({exerciseId: ex.id, exerciseName: ex.name, sets: []}))};
  startTimer(); renderWorkout();
}
function showBodyWeightModal(t) {
  currentBodyWeightType = t;
  const val = t === 'before' ? currentWorkout.bodyWeightBefore : currentWorkout.bodyWeightAfter;
  document.getElementById('bodyWeightValue').textContent = val ? val.toFixed(1) : '70.0';
  document.getElementById('bodyWeightModalTitle').textContent = t === 'before' ? '–í–µ—Å –¥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏' : '–í–µ—Å –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏';
  showModal('bodyWeightModal');
}
function confirmBodyWeight() {
  const w = parseFloat(document.getElementById('bodyWeightValue').textContent);
  currentBodyWeightType === 'before' ? currentWorkout.bodyWeightBefore = w : currentWorkout.bodyWeightAfter = w;
  closeModal('bodyWeightModal'); renderWorkout();
}
function showAddSetModal(exId) {
  currentExerciseForSet = exId; const ex = currentWorkout.exercises.find(e => e.exerciseId === exId);
  if (ex.sets.length) { const ls = ex.sets[ex.sets.length - 1]; document.getElementById('setWeight').value = ls.weight.toFixed(1); document.getElementById('setReps').value = ls.reps; selectMood(ls.mood); } else { document.getElementById('setWeight').value = '50.0'; document.getElementById('setReps').value = '10'; selectMood(3); }
  showModal('setModal');
}
function confirmAddSet() {
  const w = parseFloat(document.getElementById('setWeight').value), r = parseInt(document.getElementById('setReps').value);
  currentWorkout.exercises.find(e => e.exerciseId === currentExerciseForSet).sets.push({weight: w, reps: r, mood: currentMood, timestamp: Date.now()});
  closeModal('setModal'); renderWorkout();
}
function addSetSameAsPrevious() {
  const ex = currentWorkout.exercises.find(e => e.exerciseId === currentExerciseForSet); if (!ex.sets.length) return alert('–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤');
  const ls = ex.sets[ex.sets.length - 1]; ex.sets.push({...ls, timestamp: Date.now()}); closeModal('setModal'); renderWorkout();
}
function deleteSet(exId, idx) { if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥?')) return; currentWorkout.exercises.find(e => e.exerciseId === exId).sets.splice(idx, 1); renderWorkout(); }
function finishWorkout() {
  if (!currentWorkout) return; currentWorkout.exercises = currentWorkout.exercises.filter(e => e.sets.length);
  if (!currentWorkout.exercises.length) return alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥');
  const mood = prompt('–û—Ü–µ–Ω–∏—Ç–µ –æ–±—â–µ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (1-5):', '3'); if (mood) currentWorkout.overallMood = Math.min(5, Math.max(1, parseInt(mood) || 3));
  currentWorkout.endDate = new Date().toISOString(); workouts.push(currentWorkout); checkAndUnlockAchievements(currentWorkout); saveData(); stopTimer(); currentWorkout = null; alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! üí™'); renderWorkout();
}
function cancelWorkout() { if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É? –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) return; currentWorkout = null; stopTimer(); renderWorkout(); }
function getMoodEmoji(m) { return m === 1 ? 'üò´' : m === 5 ? 'üòÑ' : 'üòê'; }

function renderWorkout() {
  const cont = document.getElementById('workoutContent');
  if (!currentWorkout) { cont.innerHTML = `<div class="empty-state"><h3>–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</h3><div class="btn-group"><button class="btn" onclick="startWorkout()">–°–≤–æ–±–æ–¥–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button></div></div>`; return; }
  const before = currentWorkout.bodyWeightBefore ? `<strong>${currentWorkout.bodyWeightBefore.toFixed(1)} –∫–≥</strong>` : `<button class="btn btn-small btn-secondary" onclick="showBodyWeightModal('before')">–£–∫–∞–∑–∞—Ç—å</button>`;
  const after = currentWorkout.bodyWeightAfter ? `<strong>${currentWorkout.bodyWeightAfter.toFixed(1)} –∫–≥</strong>` : `<button class="btn btn-small btn-secondary" onclick="showBodyWeightModal('after')">–£–∫–∞–∑–∞—Ç—å</button>`;
  cont.innerHTML = `
    <div class="weight-input-group"><h3 style="margin-bottom:15px">üìä –í–µ—Å —Ç–µ–ª–∞</h3><div class="weight-row"><span>–î–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:</span>${before}</div><div class="weight-row"><span>–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:</span>${after}</div></div>
    <div class="btn-group"><button class="btn" onclick="finishWorkout()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button><button class="btn btn-danger" onclick="cancelWorkout()">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button></div>
    ${currentWorkout.exercises.map(ex => {
      const first = ex.sets[0], last = ex.sets[ex.sets.length - 1], dur = first && last ? Math.round((last.timestamp - first.timestamp) / 60000) : 0;
      return `<div class="workout-exercise"><h3><span>${ex.exerciseName}</span><span style="font-size:14px;font-weight:normal;color:#6c757d">${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤${dur ? ` ‚Ä¢ ${dur} –º–∏–Ω` : ''}</span></h3>
        <button class="btn btn-success btn-small" onclick="showAddSetModal(${ex.exerciseId})" style="margin-bottom:15px">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
        ${ex.sets.length ? `<ul class="sets-list">${ex.sets.map((s,i) => `<li class="set-item"><div class="set-info"><div><strong>${i+1}.</strong> ${s.weight} –∫–≥ √ó ${s.reps} –ø–æ–≤—Ç.</div><div class="set-time">${new Date(s.timestamp).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}</div></div><div style="display:flex;align-items:center;gap:10px"><span class="set-mood">${getMoodEmoji(s.mood)}</span><button class="btn btn-small btn-danger" onclick="deleteSet(${ex.exerciseId},${i})">√ó</button></div></li>`).join('')}</ul>` : '<p style="color:#6c757d;text-align:center;padding:20px">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥–æ–≤</p>'}</div>`;
    }).join('')}`;
}

/* =================  –ò–°–¢–û–†–ò–Ø / –°–¢–ê–¢–ò–°–¢–ò–ö–ê / –î–û–°–¢–ò–ñ–ï–ù–ò–Ø  ================= */
function renderHistory() {
  const list = document.getElementById('historyList');
  if (!workouts.length) { list.innerHTML = '<div class="empty-state"><h3>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</h3><p>–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</p></div>'; return; }
  list.innerHTML = [...workouts].sort((a,b)=>new Date(b.startDate)-new Date(a.startDate)).map(w => {
    const start = new Date(w.startDate), end = w.endDate ? new Date(w.endDate) : null, dur = end ? Math.round((end-start)/60000) : 0;
    const sets = w.exercises.reduce((s,e)=>s+e.sets.length,0), vol = w.exercises.reduce((s,e)=>s+e.sets.reduce((v,st)=>v+st.weight*st.reps,0),0);
    return `<div class="history-item" onclick="this.classList.toggle('expanded')"><div class="history-header"><span class="history-date">${start.toLocaleDateString('ru-RU')} ${start.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}${end?' ‚Äì '+end.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}):''}</span>${w.overallMood?`<span class="history-badge">${getMoodEmoji(w.overallMood)}</span>`:''}</div><div style="color:#6c757d;font-size:14px;margin-bottom:5px"><strong>${w.templateName||'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}</strong></div><div style="color:#6c757d;font-size:14px">${w.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ‚Ä¢ ${sets} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${(vol/1000).toFixed(1)} —Ç–æ–Ω–Ω${dur?' ‚Ä¢ '+dur+' –º–∏–Ω':''}${w.bodyWeightBefore?' ‚Ä¢ '+w.bodyWeightBefore.toFixed(1)+' –∫–≥':''}</div><div class="history-details">${w.exercises.map(ex=>`<div style="margin-bottom:20px;background:#fff;padding:15px;border-radius:8px"><strong style="color:#667eea">${ex.exerciseName}</strong><ul class="sets-list" style="margin-top:10px">${ex.sets.map((s,i)=>`<li class="set-item"><div class="set-info"><div>${i+1}. ${s.weight} –∫–≥ √ó ${s.reps} –ø–æ–≤—Ç.</div><div class="set-time">${new Date(s.timestamp).toLocaleTimeString('ru-RU')}</div></div>${s.mood?`<span class="set-mood">${getMoodEmoji(s.mood)}</span>`:''}</li>`).join('')}</ul></div>`).join('')}${w.bodyWeightBefore||w.bodyWeightAfter?`<div style="margin-top:15px;padding:15px;background:#e7e9fc;border-radius:8px"><strong>–í–µ—Å —Ç–µ–ª–∞:</strong><br>${w.bodyWeightBefore?`–î–æ: ${w.bodyWeightBefore.toFixed(1)} –∫–≥`:''} ${w.bodyWeightAfter?`${w.bodyWeightBefore?'‚Üí':''} –ü–æ—Å–ª–µ: ${w.bodyWeightAfter.toFixed(1)} –∫–≥`:''}</div>`:''}</div></div>`;
  }).join('');
}
function renderProgress() {
  const totalWorkouts = workouts.length, totalSets = workouts.reduce((s,w)=>s+w.exercises.reduce((a,e)=>a+e.sets.length,0),0);
  const totalVol = workouts.reduce((s,w)=>s+w.exercises.reduce((a,e)=>a+e.sets.reduce((v,st)=>v+st.weight*st.reps,0),0),0);
  const avgM = workouts.filter(w=>w.overallMood).length ? (workouts.filter(w=>w.overallMood).reduce((a,w)=>a+w.overallMood,0)/workouts.filter(w=>w.overallMood).length).toFixed(1) : 'N/A';
  const latestW = [...workouts].reverse().find(w=>w.bodyWeightBefore)?.bodyWeightBefore;
  const totalMs = workouts.reduce((s,w)=>w.endDate?s+(new Date(w.endDate)-new Date(w.startDate)):s,0), totalH = Math.round(totalMs/3600000);
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card"><div class="stat-value">${totalWorkouts}</div><div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
    <div class="stat-card"><div class="stat-value">${totalSets}</div><div class="stat-label">–ü–æ–¥—Ö–æ–¥–æ–≤</div></div>
    <div class="stat-card"><div class="stat-value">${(totalVol/1000).toFixed(1)}</div><div class="stat-label">–¢–æ–Ω–Ω –ø–æ–¥–Ω—è—Ç–æ</div></div>
    <div class="stat-card"><div class="stat-value">${avgM}</div><div class="stat-label">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div></div>
    <div class="stat-card"><div class="stat-value">${latestW?latestW.toFixed(1):'N/A'}</div><div class="stat-label">–í–µ—Å (–∫–≥)</div></div>
    <div class="stat-card"><div class="stat-value">${totalH}</div><div class="stat-label">–ß–∞—Å–æ–≤ –≤ –∑–∞–ª–µ</div></div>`;
  renderCharts();
}
function renderExercises() {
  const list = document.getElementById('exercisesList');
  if (!exercises.length) { list.innerHTML = '<div class="empty-state"><h3>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞</h3><p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</p></div>'; return; }
  let html = '', grp = '';
  [...exercises].sort((a,b)=>(a.group||'–ü—Ä–æ—á–∏–µ').localeCompare(b.group||'–ü—Ä–æ—á–∏–µ')).forEach(ex => {
    if (ex.group !== grp) { grp = ex.group || '–ü—Ä–æ—á–∏–µ'; html += `<div class="exercise-group-title">${grp}</div>`; }
    html += `<li class="exercise-item"><div><strong>${ex.name}</strong>${ex.group?`<span style="color:#6c757d;font-size:12px;display:block">${ex.group}</span>`:''}</div><div class="exercise-actions">${ex.system?'':`<button class="btn btn-small btn-danger" onclick="deleteExercise(${ex.id})">√ó</button>`}</div></li>`;
  });
  list.innerHTML = html;
}
function viewAllExercises() {
  const cont = document.getElementById('exercisesLibraryContent');
  cont.innerHTML = renderExercisesLibrary();
  showModal('exercisesLibraryModal');
}
function renderExercisesLibrary() {
  if (!exercises.length) return '<p style="text-align:center;color:#6c757d">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>';
  let html = '', grp = '';
  [...exercises].sort((a,b)=>(a.group||'–ü—Ä–æ—á–∏–µ').localeCompare(b.group||'–ü—Ä–æ—á–∏–µ')||a.name.localeCompare(b.name)).forEach(ex => {
    if (ex.group !== grp) { grp = ex.group || '–ü—Ä–æ—á–∏–µ'; html += `<div class="exercise-group-title">${grp}</div>`; }
    html += `<div class="exercise-item" style="margin-bottom:10px"><div><strong>${ex.name}</strong>${ex.system?'':' <span style="color:#28a745;font-size:12px">(–≤–∞—à–µ)</span>'}</div>${ex.system?'':`<button class="btn btn-small btn-danger" onclick="deleteExerciseFromLibrary(${ex.id})">√ó</button>`}</div>`;
  });
  return html;
}
function deleteExerciseFromLibrary(id) { deleteExercise(id); document.getElementById('exercisesLibraryContent').innerHTML = renderExercisesLibrary(); }

/* =================  –ì–†–ê–§–ò–ö–ò  ================= */
function renderCharts() {
  const exId = parseInt(document.getElementById('exerciseSelect').value);
  updateBodyWeightChart(); updateMoodChart(); if (!exId) return;
  const exName = exercises.find(e => e.id === exId)?.name;
  const data = [];
  workouts.forEach(w => {
    const ex = w.exercises.find(e => e.exerciseId === exId);
    if (ex && ex.sets.length) { data.push({date: new Date(w.startDate).toLocaleDateString('ru-RU'), maxWeight: Math.max(...ex.sets.map(s => s.weight)), volume: ex.sets.reduce((a, s) => a + s.weight * s.reps, 0)}); }
  });
  if (!data.length) return;
  if (weightChart) weightChart.destroy(); weightChart = new Chart(document.getElementById('weightChart'), {type: 'line', data: {labels: data.map(d => d.date), datasets: [{label: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å (–∫–≥)', data: data.map(d => d.maxWeight), borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,.1)', tension: .4, fill: true}]}, options: {responsive: true, plugins: {title: {display: true, text: `${exName} ‚Äì –†–æ—Å—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤–µ—Å–∞`}}}});
  if (volumeChart) volumeChart.destroy(); volumeChart = new Chart(document.getElementById('volumeChart'), {type: 'bar', data: {labels: data.map(d => d.date), datasets: [{label: '–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂ (–∫–≥)', data: data.map(d => d.volume), backgroundColor: '#764ba2'}]}, options: {responsive: true, plugins: {title: {display: true, text: `${exName} ‚Äì –û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂`}}}});
}
function updateBodyWeightChart() {
  const data = workouts.filter(w => w.bodyWeightBefore || w.bodyWeightAfter).map(w => ({date: new Date(w.startDate).toLocaleDateString('ru-RU'), before: w.bodyWeightBefore, after: w.bodyWeightAfter}));
  if (!data.length) { if (bodyWeightChart) { bodyWeightChart.destroy(); bodyWeightChart = null; } return; }
  if (bodyWeightChart) bodyWeightChart.destroy();
  bodyWeightChart = new Chart(document.getElementById('bodyWeightChart'), {type: 'line', data: {labels: data.map(d => d.date), datasets: [{label: '–í–µ—Å –¥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–∫–≥)', data: data.map(d => d.before), borderColor: '#28a745', backgroundColor: 'rgba(40,167,69,.1)', tension: .4}, {label: '–í–µ—Å –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–∫–≥)', data: data.map(d => d.after), borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,.1)', tension: .4}]}, options: {responsive: true, plugins: {title: {display: true, text: '–î–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞ —Ç–µ–ª–∞'}}}});
}
function updateMoodChart() {
  const data = workouts.filter(w => w.overallMood).map(w => ({date: new Date(w.startDate).toLocaleDateString('ru-RU'), mood: w.overallMood}));
  if (!data.length) { if (moodChart) { moodChart.destroy(); moodChart = null; } return; }
  if (moodChart) moodChart.destroy();
  moodChart = new Chart(document.getElementById('moodChart'), {type: 'line', data: {labels: data.map(d => d.date), datasets: [{label: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ (1-5)', data: data.map(d => d.mood), borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,.1)', tension: .4, fill: true}]}, options: {responsive: true, scales: {y: {min: 1, max: 5, ticks: {stepSize: 1}}}, plugins: {title: {display: true, text: '–î–∏–Ω–∞–º–∏–∫–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è'}}}});
}

/* =================  –î–û–°–¢–ò–ñ–ï–ù–ò–Ø  ================= */
const getWorkoutVolume = w => w.exercises.reduce((s, e) => s + e.sets.reduce((a, st) => a + st.weight * st.reps, 0), 0);
const getTotalVolume = ww => ww.reduce((t, w) => t + getWorkoutVolume(w), 0);
const ACHIEVEMENT_CATEGORIES = [
  {name: '–ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ', achievements: [
    {id: 'c1', title: '–ù–æ–≤–∏—á–æ–∫', description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å 1 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É', icon: 'üå±', checker: ww => ww.length >= 1},
    {id: 'c10', title: '–ü—Ä–∏–≤—ã—á–∫–∞', description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å 10 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', icon: 'üí™', checker: ww => ww.length >= 10},
    {id: 'c50', title: '–†–∞–±–æ—Ç—è–≥–∞', description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å 50 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', icon: 'üî•', checker: ww => ww.length >= 50},
    {id: 'c100', title: '–í–µ—Ç–µ—Ä–∞–Ω –ó–∞–ª–∞', description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å 100 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', icon: 'üèÜ', checker: ww => ww.length >= 100}
  ]},
  {name: '–¢–æ–Ω–Ω–∞–∂ –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É', achievements: [
    {id: 'v1t', title: '–ü–µ—Ä–≤–∞—è —Ç–æ–Ω–Ω–∞', description: '–ü–æ–¥–Ω—è—Ç—å >1 —Ç –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É', icon: 'üèãÔ∏è', checker: (ww, lw) => getWorkoutVolume(lw) > 1000},
    {id: 'v5t', title: '–°–∏–ª–∞—á', description: '–ü–æ–¥–Ω—è—Ç—å >5 —Ç –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É', icon: 'ü¶¨', checker: (ww, lw) => getWorkoutVolume(lw) > 5000}
  ]},
  {name: '–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂', achievements: [
    {id: 't100t', title: '–¢–æ–Ω–Ω—ã–π –∫–ª—É–±', description: '–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂ >100 —Ç', icon: 'üè≠', checker: ww => getTotalVolume(ww) > 100000},
    {id: 't500t', title: '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä —Ç–µ–ª–∞', description: '–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂ >500 —Ç', icon: 'üèõÔ∏è', checker: ww => getTotalVolume(ww) > 500000}
  ]}
];
function checkAndUnlockAchievements(lastWorkout) {
  const newly = [];
  ACHIEVEMENT_CATEGORIES.forEach(cat => cat.achievements.forEach(a => {
    if (!unlockedAchievements.includes(a.id) && a.checker(workouts, lastWorkout)) { newly.push(a); unlockedAchievements.push(a.id); }
  }));
  if (newly.length) { const titles = newly.map(a => `¬´${a.title}¬ª`).join(', '); setTimeout(() => alert(`üéâ –ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!\n\n${titles}`), 500); }
}
function renderAchievements() {
  const cont = document.getElementById('achievementsListContainer'); cont.innerHTML = '';
  ACHIEVEMENT_CATEGORIES.forEach(cat => {
    const title = document.createElement('h3'); title.className = 'achievement-category-title'; title.textContent = cat.name; cont.appendChild(title);
    const grid = document.createElement('div'); grid.className = 'achievements-grid';
    grid.innerHTML = cat.achievements.map(a => `
      <div class="achievement-card ${unlockedAchievements.includes(a.id) ? 'unlocked' : ''}">
        <div class="achievement-icon">${a.icon}</div><div class="achievement-title">${a.title}</div><div class="achievement-desc">${a.description}</div>
      </div>`).join('');
    cont.appendChild(grid);
  });
}

/* =================  –≠–ö–°–ü–û–†–¢ / –°–ë–†–û–°  ================= */
function exportData() {
  const data = {exercises, workouts, templates, exportDate: new Date().toISOString()};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `gym-tracker-backup-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
  alert('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã! üì•');
}
function confirmReset() {
  if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ:\n‚Ä¢ –í—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n‚Ä¢ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è\n‚Ä¢ –®–∞–±–ª–æ–Ω—ã\n‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
  if (confirm('–•–æ—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ?')) { exportData(); setTimeout(() => { if (confirm('–¢–µ–ø–µ—Ä—å —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) resetAllData(); }, 1000); } else { if (confirm('–ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï!\n\n–í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) resetAllData(); }
}
function resetAllData() { localStorage.clear(); initializeExercises(); workouts = []; templates = []; unlockedAchievements = []; currentWorkout = null; saveData(); alert('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã! üóëÔ∏è'); location.reload(); }
function saveData() { localStorage.setItem('exercises', JSON.stringify(exercises)); localStorage.setItem('workouts', JSON.stringify(workouts)); localStorage.setItem('templates', JSON.stringify(templates)); localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedAchievements)); }

/* =================  –ó–ê–ü–£–°–ö  ================= */
document.addEventListener('DOMContentLoaded', () => {
  initializeExercises(); 
  const savedEx = JSON.parse(localStorage.getItem('exercises')) || [];
  const savedW = JSON.parse(localStorage.getItem('workouts')) || [];
  const savedT = JSON.parse(localStorage.getItem('templates')) || [];
  templates = savedT.map(t => ({...t, exercises: t.exercises.filter(ex => exercises.some(e => e.id === ex.exerciseId))}));
  workouts = savedW; unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];
  renderExercises(); renderWorkout();
});
</script>
</body>
</html>
